<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Quality TV</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; }
  iframe { width:100%; height:100%; border:5; }
</style>
</head>
<body>
  <div id="wrap">
    <iframe id="a" class="frame show" allow="autoplay" src="/embed/oven?dept=quality&chart=timeseries&range=lastHour"></iframe>
    <iframe id="b" class="frame" allow="autoplay" src="about:blank"></iframe>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // -------- CONFIG --------
    const DEPT = "quality";
    const DASHBOARD_URL = `/dashboard/${DEPT}?tv=1&sound=1`;

    const ROTATE_URLS = [
      `/embed/oven?dept=quality&chart=timeseries&range=lastHour&title=Oven Completions — Last Hour`,
      `/embed/oven?dept=quality&chart=timeseries&range=prevWeek&title=Oven Completions — Last Week`,
      `/embed/oven?dept=quality&chart=cureTimeseries&range=prevShift&title=Cure Time — Prev Shift`,
      `/embed/oven?dept=quality&chart=cureTimeseries&range=prevWeek&size=2&title=Cure Time (Size 2) — Prev Week`,

      `/embed/oven?dept=quality&chart=shiftTotals&range=prevWeek&title=Shift Totals — Last Week`,
      `/embed/oven?dept=quality&chart=shiftTotals&range=prevDay&title=Shift Totals — Previous Day`,
      `/embed/oven?dept=quality&chart=shiftTotals&range=thisShift&title=Shift Totals — Current Shift`
    ];

    const ROTATE_EVERY_MS = 7 * 1000; // Rotation Interval*Number of Screens should not exceed refresh rate of WebLauncher app.(60 seconds)
    const RETURN_COOLDOWN_MS = 15 * 1000;
    const FADE_MS = 1 * 1000; // transition speed
    // ------------------------

    // Add fade styles
    const style = document.createElement("style");
    style.textContent = `
      html,body{margin:0;height:100%;background:#000;overflow:hidden}
      #wrap{position:fixed;inset:0;background:#000}
      .frame{position:absolute;inset:0;border:0;width:100%;height:100%;opacity:0;transition:opacity ${FADE_MS}ms ease}
      .frame.show{opacity:1}
    `;
    document.head.appendChild(style);

    const socket = io({ query: { dept: DEPT } });

    const a = document.getElementById("a");
    const b = document.getElementById("b");
    let front = a, back = b;

    let rotateIndex = 0;
    let rotateTimer = null;
    let inAlertMode = false;
    let returnCooldownTimer = null;

    function anyActiveCall(snapshot) {
      return Array.isArray(snapshot?.cells) && snapshot.cells.some(c => c.status === "WAITING");
    }

    function swapTo(url) {
      // Load into back iframe, then crossfade when loaded
      back.onload = () => {
        back.classList.add("show");
        front.classList.remove("show");

        // swap refs
        const tmp = front;
        front = back;
        back = tmp;

        // stop repeated onload firing
        back.onload = null;
      };
      back.src = url;
    }

    function startRotation() {
      stopRotation();
      if (!ROTATE_URLS.length) return;

      swapTo(ROTATE_URLS[rotateIndex % ROTATE_URLS.length]);

      rotateTimer = setInterval(() => {
        if (inAlertMode) return;
        rotateIndex = (rotateIndex + 1) % ROTATE_URLS.length;
        swapTo(ROTATE_URLS[rotateIndex]);
      }, ROTATE_EVERY_MS);
    }

    function stopRotation() {
      if (rotateTimer) clearInterval(rotateTimer);
      rotateTimer = null;
    }

    function enterAlertMode() {
      inAlertMode = true;
      if (returnCooldownTimer) clearTimeout(returnCooldownTimer);
      returnCooldownTimer = null;
      stopRotation();
      swapTo(DASHBOARD_URL);
    }

    function exitAlertMode() {
      inAlertMode = false;
      if (returnCooldownTimer) clearTimeout(returnCooldownTimer);
      returnCooldownTimer = setTimeout(() => startRotation(), RETURN_COOLDOWN_MS);
    }

    socket.on("connect", () => startRotation());

    socket.on("deptSnapshot", (snap) => {
      const active = anyActiveCall(snap);
      if (active && !inAlertMode) enterAlertMode();
      if (!active && inAlertMode) exitAlertMode();
    });

    socket.on("disconnect", () => {
      // keep showing whatever is on screen; resume rotation
      startRotation();
    });
  </script>
</body>
